<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout_admin}"
      xmlns:th="http://www.thymeleaf.org">

<style layout:fragment="css">
</style>

<!-- default_layout_admin.html 에 정의한 main page 부분 -->
<div layout:fragment="content">
    <!--컨텐츠 내용-->
    <div class="admin">
        <div class="pageTitle-wrap">
            <h3 class="title">부대비용 관리</h3>
            <ul class="contentMenu">
                <li><a href="/management">HOME</a></li>
                <li><a href="/management/members">회원관리</a></li>
                <li><a href="/management/managers">수익리스트</a></li>
            </ul>
        </div>

        <div class="revenue-admin-wrap">
            <div class="inventList page-tableBox pc768-wrap wait-list cost-rate-border">
                <div class="cost-rate-inner">
                    <h3 class="yellow">현재 이자율 (%)</h3>
                    <div class="cost-rate">
                        <input type="text" placeholder="2.3" id="interestRate">
                        <button class="yellow-btn" onclick="updateRate();">저장</button>
                    </div>
                </div>
                <div class="cost-rate-list-inner">
                    <div class="cost-rate-list">
                        <h3>지난 이자 리스트</h3>
                        <span id="overView">
                        <p><em id="amount"></em> 원</p>
                        <p>총금액 <span id="total"></span>원</p>
                    </span>
                    </div>
                    <div class="dateBox">
                        <input type="date" id="dateFrom" class="cost-date">
                        <span> ~ </span>
                        <input type="date" id="dateTo" class="cost-date">
                        <button class="searchBox">
                            <span id="date-search-icon" class="search-icon"></span>
                        </button>
                    </div>

                    <table class="page-table1 table-hover">
                        <colgroup>
                            <col style="width:10%">
                            <col style="width:10%">
                            <col style="width:10%">
                            <col style="width:10%">
                        </colgroup>
                        <thead id="interestListThead">
                        <tr>
                            <th><p class="sort" sort="createdAt">날짜</p></th>
                            <th><p class="sort" sort="interestRate">이자율</p></th>
                            <th><p class="sort" sort="total">총금액</p></th>
                            <th><p class="sort" sort="amount">이자액</p></th>
                        </tr>
                        </thead>
                        <tbody id="interestListTbody">
                        <tr class="past-cost">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <!--<tr class="past-cost">
                            <td>2022-09-07</td>
                            <td class="red">50%
                                <i class="fa fa-light fa-arrow-up"></i>
                            </td>
                            <td>60,000,000P</td>
                            <td>60,000,000P</td>
                        </tr>-->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="inventList page-tableBox pc768-wrap border-none user-cost-list">
                <div class="box-inner user-cost-none">
                    <h3>회원별 이자 리스트</h3>
                    <div class="selectBox-inner">
                        <div class="selectBox">
                            <select id="queryType" class="mr10">
                                <option value="전체">전체</option>
                                <option value="이름">이름</option>
                                <option value="아이디">아이디</option>
                                <option value="회원번호">회원번호</option>
                            </select>
                        </div>
                        <div class="searchBox">
                            <input type="text" id="query" placeholder="검색 키워드">
                            <span id="search-icon" class="search-icon"></span>
                        </div>
                    </div>
                </div>

                <table class="page-table1 table-hover page-tableBox cost-table">
                    <colgroup>
                        <col style="width:10%">
                        <col style="width:10%">
                        <col style="width:15%">
                        <col style="width:10%">
                        <col style="width:10%">
                        <col style="width:10%">
                    </colgroup>
                    <thead id="userListThead">
                    <tr>
                        <th><p class="sort" sort="membershipNumber">회원번호</p></th>
                        <th><p class="sort" sort="name">이름</p></th>
                        <th><p class="sort" sort="userId">아이디</p></th>
                        <th><p class="sort" sort="investment">레벨</p></th>
                        <th><p class="sort" sort="total">총금액</p></th>
                        <th><p class="sort" sort="amount">이자액</p></th>
                    </tr>
                    </thead>
                    <tbody id="userListTbody">
                    <!--<tr>
                        <td>00001</td>
                        <td>김지영</td>
                        <td>rkaskan@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>-->
                    <!--<tr>
                        <td>00001</td>
                        <td>김지영</td>
                        <td>rkaskan@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>
                    <tr>
                        <td>00001</td>
                        <td>김지영</td>
                        <td>rkaskan@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>-->
                    </tbody>
                </table>

                <!--paging-->
                <div id="pagination" class="paging">
                    <!-- <a href="#" class="page-arrow1 page-arrow pc-mr05">처음 게시물 목록</a>
                     <a href="#" class="page-arrow2 page-arrow">이전 게시물 목록</a>
                     <div class="page-num">
                         <a href="#" class="actived">1</a>
                         <a href="#">2</a>
                         <a href="#">3</a>
                         <a href="#">4</a>
                         <a href="#">5</a>
                     </div>
                     <a href="#" class="page-arrow3 page-arrow pc-mr05">다음 게시물 목록</a>
                     <a href="#" class="page-arrow4 page-arrow">마지막 게시물 목록</a>-->
                </div>
            </div>
        </div>

        <!-- 모달 -->
        <div id="user-interest-details-modal" class="invent-modal modal revenue-modal2 cost-modal">
            <div class="modal-inner">
                <div class="modal-title">
                    <p class="title"><span id="title-name">사용자</span>님 지난 이자 리스트</p>
                    <a href="#" class="close-btn">닫기</a>
                </div>
                <div class="modal-text">
                    <div class="dateBox">
                        <input id="modalDateFrom" type="date">
                        <span> ~ </span>
                        <input id="modalDateTo" type="date">
                        <button class="searchBox"><span id="modal-date-search-icon" class="search-icon"></span></button>
                        <button class="month yellow-btn 3month" val="3">3개월</button>
                        <button class="month gray-btn 6month" val="6" >6개월</button>
                        <button class="month gray-btn 1year" val="12">1년</button>
                    </div>
                </div>
                <div class="modal-scroll-div">
                    <table class="revenue-table">
                        <colgroup>
                            <col style="width:*%">
                            <col style="width:*%">
                            <col style="width:*%">
                        </colgroup>
                        <thead>
                        <tr>
                            <th>날짜</th>
                            <th>총금액</th>
                            <th>이자액</th>
                        </tr>
                        </thead>
                        <tbody id="modalUserDetailsListTbody">
                        <!--<tr>
                            <td>2022-06</td>
                            <td>34,000,000,000P</td>
                            <td>34,000,000,000P</td>
                        </tr>
                        <tr>
                            <td>2022-06</td>
                            <td>34,000,000,000P</td>
                            <td>34,000,000,000P</td>
                        </tr>-->
                        </tbody>
                    </table>
                </div>
                <div class="modal-btn">
                    <a href="#" class="white-btn close-btn mr10">닫기</a>
                </div>
            </div>
            <div class="modal-bg"></div>
        </div>

        <div class="invent-modal modal dues-alram">

        </div>
    </div>

    <script src="/js/script.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/dev.js"></script>

    <script>
        let userDetailsSeq;
        let interestSeq;
        let sort = "createdAt,desc";
        let userSort = "createdAt,desc";
        let page = 1;
        let today = new Date();
        let preDay = new Date(new Date().setMonth(new Date().getMonth() - 3));
        $("#dateFrom").val(strDate(preDay));
        $("#dateTo").val(strDate(today));


        $('.past-cost').click(function () {
            $('.cost-modal').css('display', 'block');
        });

        getInterest();
        getInterestList();
        getUserInterestList(interestSeq);

        function getInterest() {
            $.ajax({
                type: "get",
                url: "/api/admin/interest/rate",
                success: function (data) {
                    $("#interestRate").val(data.interestRate);
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        function updateRate() {
            let interestRate = $("#interestRate").val();

            $.ajax({
                type: 'put',
                url: '/api/admin//interest/rate',
                contentType: 'application/json',
                data: JSON.stringify({
                    "interestRate": interestRate
                }),
                success: function (data) {
                    toastModal("이자율이 저장(수정) 되었습니다.");
                    setTimeout(() => location.reload(), 700);
                },
                error: function (request, status, error) {
                    toastModal("이자율 저장(수정)에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        /** 지난 이자 리스트 START **/

        $("#interestListTbody").on("click", "tr", function() {
            interestSeq = $(this).attr("seq");
            page=1;
            $("#queryType").val("전체");
            $("#query").val("");
            getUserInterestList(interestSeq);
        });

        $("#date-search-icon").on("click", function () {
            getInterestList();
            getUserInterestList(interestSeq);
        });

        // 이자 목록 정렬
        $("#interestListThead").on("click", ".sort", function () {
            sort = $(this).attr('sort');

            if (!$(this).is('.actived')) {
                $(this).removeClass('actived');
                sort = sort + ',desc';
            } else {
                sort = sort + ',asc';
                $(this).addClass('actived');

            }
            $('.sort').not(this).removeClass('actived');
            getInterestList();
        });

        function getInterestList() {
            let dateFrom = $("#dateFrom").val();
            let dateTo = $("#dateTo").val();
            $.ajax({
                type: "get",
                url: "/api/admin/interest",
                data: {
                    "dateFrom": dateFrom + " 00:00:00",
                    "dateTo": dateTo + " 23:59:59"
                },
                async: false,
                success: function (data) {
                    // console.log(data);
                    let list = data.content;
                    let tag = '';
                    if (list.length != 0) {
                        $("#amount").text(fcomma(list[0].amount));
                        $("#total").text(fcomma(list[0].total));
                        $("#overView").removeClass("d-none");
                        interestSeq = list[0].interestSeq;
                        list.forEach(function (arg) {
                            tag += '<tr class="past-cost" seq="' + arg.interestSeq + '">' +
                                '<td>' + arg.createdAt + '</td>' +
                                '<td>' + arg.interestRate + ' %</td>' +
                                '<td class="amount">' + fcomma(arg.total) + '</td>' +
                                '<td class="total">' + fcomma(arg.amount) + '</td>' +
                                '</tr>';
                        });
                    } else {
                        $("#overView").addClass("d-none");
                        interestSeq = null;
                        tag = '<tr><td colspan="4">이자 내역이 존재하지 않습니다.</td></tr>';
                    }
                    $("#interestListTbody").html(tag);
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }
        /** 지난 이자 리스트 END **/

        /** 사용자 목록 START **/

        $("#search-icon").on("click", function() {
            page=1;
            getUserInterestList(interestSeq);
        });

        $("#query").on("keydown", function(e){
            if(e.keyCode==13) {
                $("#search-icon").click();
            }
        });

        //회원별 이자 목록
        function getUserInterestList(interestSeq) {
            size = $("#size").val();
            let query = $("#query").val();
            if (interestSeq == null || interestSeq == undefined) {
                $("#userListTbody").html('<tr><td colspan="6">회원별 이자 내역이 존재하지 않습니다.</td></tr>');
                return;
            } else {
                $.ajax({
                    type: "get",
                    url: "/api/admin/interest/" + interestSeq,
                    data: {
                        "queryType": "전체",
                        "query": query,
                        "size": 20,
                        "page": page - 1,
                        "sort": userSort
                    },
                    async: false,
                    success: function (data) {
                        let list = data.content;
                        let tag ='';
                        if(list.length!=0) {
                            list.forEach(function(arg){
                                tag += '<tr seq="'+arg.userDetailsSeq+'">' +
                                    '<td>'+arg.membershipNumber+'</td>' +
                                    '<td class="name">'+arg.name+'</td>' +
                                    '<td>'+arg.userId+'</td>' +
                                    '<td>'+arg.level+'</td>' +
                                    '<td>'+fcomma(arg.total)+'</td>' +
                                    '<td>'+fcomma(arg.amount)+'</td>' +
                                    '</tr>';
                            });
                        }else {
                            tag = '<tr><td colspan="6">회원별 이자 내역이 존재하지 않습니다.</td></tr>';
                        }
                        $("#userListTbody").html(tag);
                        fPagination(data, page);
                    },
                    error: function (request, status, error) {
                        console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                    }
                });
            }
        }

        // 회원별 이자 목록 정렬
        $("#userListThead").on("click", ".sort", function () {
            userSort = $(this).attr('sort');

            if (!$(this).is('.actived')) {
                $(this).removeClass('actived');
                userSort = userSort + ',desc';
            } else {
                userSort = userSort + ',asc';
                $(this).addClass('actived');

            }
            $('#userListThead .sort').not(this).removeClass('actived');
            getUserInterestList(interestSeq);
        });

        // 페이징 클릭 시 실행
        $("#pagination").on("click", "a", function () {
            page = parseInt($(this).attr("gopage"));
            getUserInterestList(interestSeq);
        });

        /** 사용자 목록 END **/

        /** 사용자 모달 START **/

        $("#user-interest-details-modal").on("click", ".search-icon", function(){
            getUserDetailsList(userDetailsSeq);
        });

        $("#user-interest-details-modal").on("click", ".month", function(){
            $("#user-interest-details-modal .month").removeClass("yellow-btn")
            $("#user-interest-details-modal .month").addClass("gray-btn")
            $(this).removeClass("gray-btn");
            $(this).addClass("yellow-btn");

            let minus = Number($(this).attr("val"));
            let modalDateTo = $("#modalDateTo").val();
            let preDate = new Date(modalDateTo);
            preDate = new Date(preDate.setMonth(preDate.getMonth()-minus));
            $("#modalDateFrom").val(strDate(preDate));
            getUserDetailsList(userDetailsSeq);
        });



        $("#userListTbody").on("click", "tr", function() {
            let name = $(this).find(".name").text();
            let modalToday = new Date();
            let modalPreDay = new Date(new Date().setMonth(new Date().getMonth()-3));
            $("#modalDateFrom").val(strDate(modalPreDay));
            $("#modalDateTo").val(strDate(modalToday));
            userDetailsSeq = $(this).attr("seq");
            getUserDetailsList(userDetailsSeq);
            $("#title-name").text(name);
            $(".cost-modal").css("display", "block");
        });

        function getUserDetailsList(userDetailsSeq) {
            let modalDateFrom = $("#modalDateFrom").val();
            let modalDateTo = $("#modalDateTo").val();
            $.ajax({
                type:"get",
                url:"/api/admin/interest/users/"+userDetailsSeq,
                data: {
                    "dateFrom":modalDateFrom + " 00:00:00",
                    "dateTo":modalDateTo + " 23:59:59"
                },
                success:function(data) {
                    console.log(data);
                    let list = data.content;
                    let tag = '';
                    if(list.length!=0) {
                        list.forEach(function(arg) {
                            tag += '<tr>' +
                                '<td>'+arg.createdAt+'</td>' +
                                '<td>'+fcomma(arg.total)+'</td>' +
                                '<td>'+fcomma(arg.amount)+'</td>' +
                                '</tr>';
                        });
                    }else {
                        tag = '<tr><td colspan="3">이자 내역이 존재하지 않습니다.</td></tr>';
                    }
                    $("#modalUserDetailsListTbody").html(tag);
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        /** 사용자 모달 END **/


        function strDate(date) {
            let year = date.getFullYear() + "";
            let month = (date.getMonth() + 1) + "";
            let day = date.getDate() + "";

            if (month.length == 1) {
                month = "0" + month;
            }
            if (day.length == 1) {
                day = "0" + day;
            }
            return year + "-" + month + "-" + day;
        }
    </script>
</div>

</html>
