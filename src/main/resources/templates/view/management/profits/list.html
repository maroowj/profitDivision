<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="chorus" content="true" />
    <meta name="viewport" content="width=1200,user-scalable=yes">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>포인트 수익배분</title>

    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/content.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>
    <!--왼쪽 메뉴-->
    <div class="admin-leftMenu-wrap">

        <div class="adminInfo-wrap">
            <div class="img-wrap">
                <a class="img"><img src="../images/none_userIme.jpg" alt="관리자"></a>
            
                <div class="adminInfo">
                    <p class="name">관리자</p>
                    <p class="level">대표 관리자</p>
                </div>
            </div>

            <a href="#" class="adminUpdate-btn"><span></span></a>
            
        </div>
        
        <!--메뉴-->
        <ul class="navList">
            <li class="hasDep2 on">
                <a href="#">
                    <i class="fa-solid fa-user"></i><span>회원관리</span>
                </a>
                <ul class="depth2">
                    <li class="depTitle">회원관리</li>
                    <li class="on"><a href="/management/managers">관리자 관리</a></li>
                    <li><a href="/management/members">회원 리스트</a></li>
                    <li><a href="/management/waiting">가입대기 리스트</a></li>
                    <li><a href="/management/dues">회비입금 확인</a></li>
                </ul>
            </li>
            
            <li><a href="/management/investment"><i class="fa-solid fa-chart-simple"></i><span>투자관리</span></a></li>
            
            <li class="hasDep2">
                <a href="#">
                    <i class="fa fa-solid fa-coins"></i><span>수익관리</span>
                </a>
                <ul class="depth2">
                    <li class="depTitle">수익관리</li>
                    <li><a href="/management/profits">수익 리스트</a></li>
                    <li><a href="/management/withdrawals">출금 리스트</a></li>
                </ul>
            </li>
            
            <li><a href="/management/interest"><i class="fa-solid fa-receipt"></i><span>부대비용 관리</span></a></li>
            
            <li class="hasDep2">
                <a href="#">
                    <i class="fa-solid fa-ticket-simple"></i><span>적립금 관리</span>
                </a>
                <ul class="depth2">
                    <li class="depTitle">적립금 관리</li>
                    <li><a href="/management/reserves-manage">적립금 관리</a></li>
                    <li><a href="/management/reserves-list">적립금 리스트</a></li>
                </ul>
            </li>
            
            <li><a href="/management/popup"><i class="fa-solid fa-clone"></i><span>팝업관리</span></a></li>
            
            <li class="hasDep2">
                <a href="#">
                    <i class="fa-solid fa-ticket-simple"></i><span>게시판 관리</span>
                </a>
                <ul class="depth2">
                    <li class="depTitle">게시판 관리</li>
                    <li><a href="/management/notices">공지사항</a></li>
                    <li><a href="/management/faq">자주찾는질문</a></li>
                    <li><a href="#">외부 게시판</a></li>
                </ul>
            </li>
        </ul>
        
        <!--로그아웃 버튼-->
        <a href="/management/logout" class="admin-logoutBtn gray-btn comm-btn"><i class="fa-solid fa-power-off"></i><span>로그아웃</span></a>
        
        <!--메뉴 접기 버튼-->
        <a href="#" class="menuSize-btn"><i class="fa-solid fa-angles-left"></i></a>
    </div>
    
    <!--컨텐츠 내용-->
    <div class="admin">
        <div class="pageTitle-wrap">
            <h3 class="title">수익리스트</h3>
            <ul class="contentMenu">
                <li><a href="/management">HOME</a></li>
                <li><a href="/management/members">회원관리</a></li>
                <li><a href="">수익리스트</a></li>
            </ul>
        </div>

    <div class="revenue-admin-wrap">    
        <div class="inventList page-tableBox pc768-wrap wait-list revenue-admin-inner1">
            <h3>지난 수익 리스트</h3>
            <div class="dateBox">
                <input id="preDateFrom" type="date">
                <span> ~ </span>
                <input id="preDateTo" type="date">
                <button id="btnSearchProfit" class="searchBox"><span class="search-icon"></span></button>
            </div> 

            <table class="page-table1 table-hover">
                <colgroup>
                    <col style = "width:10%">
                    <col style = "width:10%">
                    <col style = "width:10%">
                </colgroup>
                <thead id="preProfitListThead">
                    <tr>
                        <th><p class="sort" sort="createdAt">날짜</p></th>
                        <th><p class="sort" sort="yield">수익률</p></th>
                        <th><p class="sort" sort="amount">수익금액</p></th>
                    </tr>
                </thead>
                <tbody id="preProfitListTbody">
                 <!--   <tr class="past-revenue">
                        <td>2022-09-07</td>
                        <td class="blue">50%
                            <i class="fa fa-light fa-arrow-down"></i>
                        </td>
                        <td>60,000,000P</td>
                    </tr>
                    <tr class="past-revenue">
                        <td>2022-09-07</td>
                        <td class="red">50%
                            <i class="fa fa-light fa-arrow-up"></i>
                        </td>
                        <td>60,000,000P</td>
                    </tr>-->
                </tbody>
            </table>
        </div>

        <div class="inventList page-tableBox pc768-wrap border-none revenue-admin-inner2">
            <div class="now-revenue">
                <h3>현재 수익 입력</h3>
                <input type="text" id="profitAmount" placeholder="숫자만 입력해주세요" onkeyup="inputNumberFormat(this)">
                <button id="btnSaveProfit" class="comm-btn yellow-btn">저장</button>
            </div>
            <div class="future-revenue-wrap">
                <div class="future-revenue1">
                    <h3><span id="expectMonth"></span>&nbsp;가상 수익</h3>
                    <div>
                        <button id="beforeMonth" class="arrow arrow-left"></button>
                        <button id="afterMonth" class="arrow arrow-right"></button>
                        <button class="vertical-menu past-revenue" ><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    </div>    
                </div>
                <div class="future-revenue2">
                    <input type="text" placeholder="숫자만 입력해주세요" id="expectProfitAmount" onkeyup="inputNumberFormat(this)">
                    <button id="btnSaveExpectProfit" class="">저장</button>
                </div>
            </div>
            <div class="box-inner">
                <h3 id="listTitle">회원별 예상 수익 리스트</h3>
                <div class="selectBox-inner">
                    <div class="selectBox">
                        <select id="expectSize" class="mr10 revenue-select">
                            <option value=20>20</option>
                            <option value=40>40</option>
                            <option value=60>60</option>
                        </select>
                    </div>
                    <div class="selectBox">
                        <select id="expectQueryType" class="mr10 revenue-select">
                            <option value="전체">전체</option>
                            <option value="이름">이름</option>
                            <option value="아이디">아이디</option>
                            <option value="회원번호">회원번호</option>
                        </select>
                    </div>
                    <div class="searchBox">
                        <input type="text" placeholder="검색어" id="expectQuery">
                        <span id="expect-search-icon" class="search-icon expect"></span>
                    </div>
                </div>
            </div>

            <table class="page-table1 table-hover2 page-tableBox page-table2">
                <colgroup>
                    <col style = "width:10%">
                    <col style = "width:10%">
                    <col style = "width:15%">
                    <col style = "width:10%">
                    <col style = "width:10%">
                    <col style = "width:10%">
                </colgroup>
                <thead id="expectProfitListThead">
                    <tr>
                        <th><p class="sort" sort="membershipNumber">회원번호</p></th>
                        <th><p class="sort" sort="name">이름</p></th>
                        <th><p class="sort" sort="userId">아이디</p></th>
                        <th><p class="sort" sort="userLevel">레벨</p></th>
                        <th><p class="sort" sort="userTotal">총금액</p></th>
                        <th><p class="sort" sort="amount">예상수익금액</p></th>
                    </tr>
                </thead>
                <tbody id="expectProfitListTbody">
                <!--    <tr class="future-revenueList">
                        <td>00001</td>
                        <td>김지영</td>
                        <td>test000@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>
                    <tr class="future-revenueList">
                        <td>00001</td>
                        <td>김지영</td>
                        <td>test22@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>
                    <tr class="future-revenueList">
                        <td>00001</td>
                        <td>김지영</td>
                        <td>test00@naver.com</td>
                        <td>5level</td>
                        <td>6,423,443P</td>
                        <td>150,500P</td>
                    </tr>-->
                </tbody>
            </table>
            <!--paging-->
            <div id="pagination" class="paging">
<!--                <a href="#" class="page-arrow1 page-arrow pc-mr05">처음 게시물 목록</a>-->
               <!-- <a href="#" class="page-arrow2 page-arrow">이전 게시물 목록</a>
                <div class="page-num">
                    <a href="#" class="actived">1</a>
                    <a href="#">2</a>
                    <a href="#">3</a>
                    <a href="#">4</a>
                    <a href="#">5</a>
                    <a href="#">6</a>
                    <a href="#">7</a>
                    <a href="#">8</a>
                    <a href="#">9</a>
                    <a href="#">10</a>
                </div>
                <a href="#" class="page-arrow3 page-arrow pc-mr05">다음 게시물 목록</a>-->
<!--                <a href="#" class="page-arrow4 page-arrow">마지막 게시물 목록</a>-->
            </div>
        </div>
    </div>
    </div>

    <!-- 예상 수익 목록 모달 -->
    <div class="invent-modal modal revenue-modal">
        <div class="modal-inner">
            <div class="modal-title">
                <p class="title">월별 가상 수익</p>
                <a href="#" class="close-btn">닫기</a>
            </div>
            <div class="modal-text">
                <div class="dateBox">
                    <input id="expectDateFrom" type="date">
                    <span> ~ </span>
                    <input id="expectDateTo" type="date">
                    <button class="searchBox"><span id="expectList-search-icon" class="search-icon"></span></button>
                </div> 
            </div>
            <div class="modal-scroll-div">
                <table class="revenue-table">
                    <colgroup>
                        <col style = "width:*%">
                        <col style = "width:*%">
                    </colgroup>
                    <thead id="modalExpectListThead">
                    <tr>
                        <th>날짜</th>
                        <th>예상수익</th>
                    </tr>
                    </thead>
                    <tbody id="modalExpectListTbody">
                    <!--    <tr>
                            <td>2022-06</td>
                            <td>34,000,000,000P</td>
                        </tr>
                        <tr>
                            <td>2022-06</td>
                            <td>34,000,000,000P</td>
                        </tr>-->
                    </tbody>
                </table>
            </div>
            <div class="modal-btn">
                <a href="#" class="white-btn close-btn mr10">닫기</a>
            </div>
        </div>
        <div class="modal-bg"></div>
    </div>

    <div id="user-profit-detail-modal" class="invent-modal modal revenue-modal2">
        <div class="modal-inner">
            <div class="modal-title">
                <p class="title"><span id="title-name" class="yellow"></span>님 수익리스트 </p>
                <a href="#" class="close-btn">닫기</a>
            </div>
            <div class="modal-text">
                <div class="dateBox">
                    <input id="modalDateFrom" type="date">
                    <span> ~ </span>
                    <input id="modalDateTo" type="date">
                    <button class="searchBox"><span class="search-icon"></span></button>
                    <button class="month gray-btn 3month" val="3">3개월</button>
                    <button class="month gray-btn 6month" val="6" >6개월</button>
                    <button class="month gray-btn 1year" val="12">1년</button>
                </div> 
            </div>
            <div class="modal-scroll-div">
                <table class="revenue-table">
                    <colgroup>
                        <col style = "width:*%">
                        <col style = "width:*%">
                        <col style = "width:*%">
                    </colgroup>
                    <thead>
                    <tr>
                        <th>날짜</th>
                        <th>수익금액</th>
                        <th>총금액</th>
                    </tr>
                    </thead>
                    <tbody id="modalUserProfitListTbody">
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <!--<tr>
                        <td>2022-06</td>
                        <td>34,000,000,000P</td>
                        <td>34,000,000,000P</td>
                    </tr>-->
                    </tbody>
                </table>
            </div>
            <div class="modal-btn">
                <a href="#" class="white-btn close-btn mr10">닫기</a>
            </div>
        </div>
        <div class="modal-bg"></div>
    </div>


    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/5f4b51f7f0.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <script src="../js/script.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/dev.js"></script>

    <script>
        let profitSeq;
        let userDetailsSeq;
        let modalSort = "createdAt,desc";
        let expectPage = 1;
        let expectSort = "membershipNumber,desc";
        let expectYear = new Date().getFullYear();
        let expectMonth = new Date().getMonth()+1;
        $("#expectMonth").text(expectYear+"년 "+expectMonth+"월");
        getExpectProfitUserList();
        getLastExpectProfit(expectYear, expectMonth);

        let today = new Date();
        let preDay = new Date(new Date().setMonth(new Date().getMonth()-6));
        $("#preDateFrom").val(strDate(preDay));
        $("#preDateTo").val(strDate(today));
        let preSort = "createdAt,desc";

        $("#preDateTo").on("change", function(){
            let dateTo = $(this).val();
            if(dateTo>strDate(today)) {
                toastModal("오늘 날짜까지 선택 가능합니다.");
                $("#preDateTo").val(strDate(today));
            }
        });

        $("#beforeMonth").on("click", function (e) {
            e.preventDefault();
            if (expectMonth == 1) {
                expectYear = expectYear - 1;
                expectMonth = 12;
            } else {
                expectMonth = expectMonth - 1;
            }
            $("#expectMonth").html(expectYear + "년 " + expectMonth + "월 ");
            let year = expectYear;
            let month = expectMonth;
            getLastExpectProfit(year, month);
            fnExpectThead();
            getExpectProfitUserList();
        });
        $("#afterMonth").on("click", function (e) {
            e.preventDefault();
            let thisYear = new Date().getFullYear();
            let thisMonth = new Date().getMonth() + 1;
            if (thisYear<expectYear+1 && thisMonth < expectMonth+1) {
                toastModal("이번달까지 조회할 수 있습니다.");
                return;
            }
            if (expectMonth == 12) {
                expectYear = expectYear + 1;
                expectMonth = 1;
            } else {
                expectMonth = expectMonth + 1;
            }
            $("#expectMonth").html(expectYear + "년 " + expectMonth + "월 ");
            let year = expectYear;
            let month = expectMonth;
            getLastExpectProfit(year, month);
            fnExpectThead();
            getExpectProfitUserList();
        });

        getPreProfitList();

        $("#btnSearchProfit").on("click", function(){
            getPreProfitList();
        });

        function getPreProfitList() {
            let preDateFrom = $("#preDateFrom").val() + " 00:00:00";
            let preDateTo = $("#preDateTo").val() + " 23:59:59";

            $.ajax({
                type:"get",
                url:"/api/admin/profits",
                data:{
                    "dateFrom":preDateFrom,
                    "dateTo":preDateTo,
                    "sort":preSort
                },
                async:false,
                success:function(data){
                    let profit = data.content;

                    let pTag = '';
                    if(profit!=null && profit.length!=0) {
                        for(i=0; i<profit.length; i++) {
                            let yield = '';
                            if(profit[i].yield>0) {
                                yield = '<td class="red">'+profit[i].yield+'% ' +
                                        '<i class="fa fa-light fa-arrow-up"></i>' +
                                        '</td>';
                            }else if(profit[i].yield<0) {
                                yield = '<td class="blue">'+profit[i].yield+'% ' +
                                    '<i class="fa fa-light fa-arrow-down"></i>' +
                                    '</td>';
                            }else if(profit[i].yield==0) {
                                yield = '<td class="gray">'+profit[i].yield+'%</td>';
                            }

                            pTag += '<tr pSeq="'+profit[i].profitSeq+'">' +
                                    '<td>'+profit[i].createdAt+'</td>';
                            pTag += yield;
                            pTag += '<td>'+fcomma(profit[i].amount)+'</td>';
                            pTag += '</td>';
                        }
                        $("#preProfitListTbody").html(pTag);
                    }else {
                        $("#preProfitListTbody").html('<tr><td colspan="3">수익 내역이 없습니다.</td></tr>');
                    }
                },
                error: function (request, status, error) {
                    toastModal("지난 수익 리스트를 불러올 수 없습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });

        }

        $("#btnSaveProfit").on("click", function(){
             saveProfit();
        });

        function saveProfit() {
            let amount = uncomma($("#profitAmount").val());
            if(!confirm("'확인'을 클릭하시면 회원들에게 수익이 배분됩니다." +
                "\n배분된 수익은 다시 회수할 수 없습니다." +
                "\n입력하신 수익은 "+fcomma(amount)+"원 입니다." +
                "\n수익을 정확히 입력하셨습니까?")) {
                return;
            }

            $.ajax({
                type:"post",
                url:"/api/admin/profits",
                contentType:"application/json",
                data:JSON.stringify({
                    "amount":amount
                }),
                success:function(data){
                    toastModal("입력한 수익이 저장되었습니다.");
                    setTimeout(() => location.reload(), 1000);
                },
                error: function (request, status, error) {
                    toastModal("수익 저장에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });

        }

        // 예상 수익 저장
        $("#btnSaveExpectProfit").on("click", function(){
            let thisYear = new Date().getFullYear();
            let thisMonth = new Date().getMonth() + 1;

            if(thisYear>=expectYear && thisMonth!=expectMonth) {
                toastModal("이번달 가상 수익만 수정할 수 있습니다.")
                return;
            }
            saveExpectProfit();
        });

        function saveExpectProfit() {
            let amount = uncomma($("#expectProfitAmount").val());
            if(!confirm("'확인'을 클릭하시면 회원들에게 노출되는 가상수익이 변경됩니다." +
                "\n입력하신 가상수익은 "+fcomma(amount)+"원 입니다." +
                "\n수익을 정확히 입력하셨습니까?")) {
                return;
            }

            $.ajax({
                type:"post",
                url:"/api/admin/profits/expected",
                contentType:"application/json",
                data:JSON.stringify({
                    "referenceYear":expectYear,
                    "referenceMonth":expectMonth,
                    "amount":amount
                }),
                async:false,
                success:function(data){
                    toastModal("입력한 가상수익이 저장되었습니다.");
                    setTimeout(() => location.reload(), 1000);
                },
                error: function (request, status, error) {
                    toastModal("가상수익 저장에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        $("#preProfitListTbody").on("click", "tr", function() {
            fnLastThead();
            profitSeq = $(this).attr("pseq");
            expectPage=1;
            getProfitUserList(profitSeq);
        })

        // 회원별 수익 리스트 221209 추가 (우람)
        function getProfitUserList(profitSeq) {
            $("#expectList-search-icon").addClass("last");
            $("#expectList-search-icon").removeClass("expect");
            $("#expectSize").addClass("last");
            $("#expectSize").removeClass("expect");
            $("#listTitle").text("회원별 수익 리스트");
            $("#pagination").addClass("last");
            $("#pagination").removeClass("expect");

            let expectQueryType = $("#expectQueryType").val();
            let expectQuery = $("#expectQuery").val();
            let expectSize = $("#expectSize").val();

            $.ajax({
                type:"get",
                url:"/api/admin/profits/users",
                data:{
                    "queryType":expectQueryType,
                    "query":expectQuery,
                    "size":expectSize,
                    "sort":expectSort,
                    "profitSeq":profitSeq
                },
                async:false,
                success:function(data) {
                    // console.log(data);
                    let expect = data.content;

                    let cTag = '';
                    if(expect!=null && expect.length!=0) {
                        for(i=0; i<expect.length; i++) {
                            cTag += '<tr class="open" uSeq="'+expect[i].userDetailsSeq+'" style="cursor: pointer;">' +
                                '<td>'+expect[i].membershipNumber+'</td>' +
                                '<td class="name">'+expect[i].name+'</td>' +
                                '<td>'+expect[i].userId+'</td>' +
                                '<td>'+expect[i].userLevel+' Level</td>' +
                                '<td>'+fcomma(expect[i].total)+'</td>' +
                                '<td>'+fcomma(expect[i].amount)+'</td>' +
                                '</tr>' ;
                        }
                        $("#expectProfitListTbody").html(cTag);
                        fPagination(data, expectPage);
                    }else {
                        $("#expectProfitListTbody").html('<tr><td colspan="6">저장된 수익 내역이 없습니다.</td></tr>');
                    }
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        // 페이징 클릭 시 실행
        $("#pagination").on("click", "a", function () {
            page = parseInt($(this).attr("gopage"));
            if($("#pagination").hasClass("last")) {
                getProfitUserList(profitSeq);
            }else {
                getExpectProfitUserList();
            }
        });

        // 회원별 예상 수익 리스트
        function getExpectProfitUserList() {
            $("#expectList-search-icon").removeClass("last");
            $("#expectList-search-icon").addClass("expect");
            $("#expectSize").removeClass("last");
            $("#expectSize").addClass("expect");
            $("#pagination").removeClass("last");
            $("#pagination").addClass("expect");

            $("#listTitle").text("회원별 예상 수익 리스트");
            let expectQueryType = $("#expectQueryType").val();
            let expectQuery = $("#expectQuery").val();
            let expectSize = $("#expectSize").val();

            $.ajax({
                type:"get",
                url:"/api/admin/profits/expected",
                data:{
                    "queryType":expectQueryType,
                    "query":expectQuery,
                    "size":expectSize,
                    "sort":expectSort,
                    "year":expectYear,
                    "month":expectMonth
                },
                success:function(data) {
                    let expect = data.content;
                    let cTag = '';
                    if(expect!=null && expect.length!=0) {
                        for(i=0; i<expect.length; i++) {
                            cTag += '<tr>' +
                                    '<td>'+expect[i].membershipNumber+'</td>' +
                                '<td>'+expect[i].name+'</td>' +
                                '<td>'+expect[i].userId+'</td>' +
                                '<td>'+expect[i].userLevel+' Level</td>' +
                                '<td>'+fcomma(expect[i].userTotal)+'</td>' +
                                '<td>'+fcomma(expect[i].amount)+'</td>' +
                                '</tr>' ;
                        }
                        $("#expectProfitListTbody").html(cTag);
                        fPagination(data, expectPage);
                    }else {
                        $("#expectProfitListTbody").html('<tr><td colspan="6">저장된 가상 수익 내역이 없습니다.</td></tr>');
                    }
                },
                error: function (request, status, error) {
                    $("#expectProfitListTbody").html('<tr><td colspan="6">저장된 가상 수익 내역이 없습니다.</td></tr>');
                    // console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        // input 숫자 입력시
        function inputNumberFormat(obj) {
            obj.value = fcomma(uncomma(obj.value));
        }

        // 지난 수익 값 불러오기
        function getLastExpectProfit(year, month) {
            $.ajax({
                type:"get",
                url:"/api/admin/profits/expected/monthly",
                data: {},
                success:function(data) {
                    // console.log(data);
                    if(month.length==1) {
                        month = "0"+month;
                    }
                    let expect = data.content;
                    if(expect!=null && expect.length!=0) {
                        for(i=0; i<expect.length; i++) {
                            if(expect[i].createdAt.substr(0,7)==(year+"-"+month)){
                                $("#expectProfitAmount").val(fcomma(expect[i].amount));
                                return false;
                            }else {
                                $("#expectProfitAmount").val(0);
                            }
                        }
                    }
                }
            });
        }

        //모달
        $('.past-revenue').click(function(){
            $("#expectDateFrom").val(strDate(preDay));
            $("#expectDateTo").val(strDate(today));
            getExpectProfitList();
            $('.revenue-modal').css('display','block'); 
        });

        // 모달 내 월별 가상 수익 목록
        function getExpectProfitList() {
            $.ajax({
                type:"get",
                url:"/api/admin/profits/expected/monthly",
                data: {
                    "dateFrom":$("#expectDateFrom").val() + " 00:00:00",
                    "dateTo":$("#expectDateTo").val() + " 23:59:59"
                },
                success:function(data) {
                    let expect = data.content;

                    let cTag = '';
                    if(expect!=null && expect.length!=0) {
                        for(i=0; i<expect.length; i++) {
                            cTag += '<tr>' +
                                '<td>'+expect[i].createdAt.substr(0,7)+'</td>' +
                                '<td>'+fcomma(expect[i].amount)+'</td>' +
                                '</tr>' ;
                        }
                        $("#modalExpectListTbody").html(cTag);
                    }else {
                        $("#modalExpectListTbody").html('<tr><td colspan="2">저장된 가상 수익 내역이 없습니다.</td></tr>');
                    }
                }
            });
        }
        $("#expectDateFrom").on("change", function(){
            let dateTo = $(this).val();
            if(dateTo>strDate(today)) {
                toastModal("오늘 날짜까지 선택 가능합니다.");
                $("#expectDateFrom").val(strDate(today));
            }
        });
        $("#expectDateTo").on("change", function(){
            let dateTo = $(this).val();
            if(dateTo>strDate(today)) {
                toastModal("오늘 날짜까지 선택 가능합니다.");
                $("#expectDateTo").val(strDate(today));
            }
        });
        // 모달 내 검색 아이콘 클릭 시
        $("#expectList-search-icon").on("click", function(){
            getExpectProfitList();
        });

/*        $('.future-revenueList').click(function(){
            $('.revenue-modal2').css('display','block'); 
        });*/

        // 지난 수익 리스트 정렬
        $("#preProfitListThead").on("click", ".sort", function(){
            preSort=$(this).attr('sort');

            if(!$(this).is('.actived')) {
                $(this).removeClass('actived');
                preSort=preSort+',desc'
            }else{
                $(this).addClass('actived');
                preSort=preSort;
            }

            $('.sort').not(this).removeClass('actived');
            getPreProfitList();
        });

        // 예상 수익 리스트 정렬
        $("#expectProfitListThead").on("click", ".sort", function(){
            expectSort=$(this).attr('sort');

            if(!$(this).hasClass('actived')) {
                // $("#expectProfitListThead .sort").addClass('actived');
                $(this).addClass('actived');
                expectSort=expectSort+',desc'
            }else{
                $("#expectProfitListThead .sort").removeClass('actived');
                // $(this).addClass('actived');
                expectSort=expectSort+',asc';
            }

            $('.sort').not(this).removeClass('actived');
            if($(this).hasClass("last")) {
                getProfitUserList(profitSeq);
            }else {
                getExpectProfitUserList();
            }
        });

        // 예상 수익출력 개수 select 변경 시
        $("#expectSize").on("change", function () {
            expectPage = 1
            if($(this).hasClass("last")) {
                fnLastThead();
                getProfitUserList(profitSeq);
            }else {
                fnExpectThead();
                getExpectProfitUserList();
            }
        });

        // 검색종류 select 변경 시
        // $("#expectQueryType").on("change", function () {
        //     page = 1
        //     getExpectProfitUserList();
        // });

        // 키워드 입력 후 Enter 눌렀을 경우
        $("#expectQuery").on("keydown", function (e) {
            if (e.keyCode == 13) {
                $("#expect-search-icon").click();
            }
        });

        // 돋보기 아이콘 클릭 시 검색
        $("#expect-search-icon").on("click", function () {
            expectPage = 1
            if($(this).hasClass("last")) {
                fnLastThead();
                getProfitUserList(profitSeq);
            }else {
                fnExpectThead();
                getExpectProfitUserList();
            }
        });

        function strDate(date) {
            let year = date.getFullYear() + "";
            let month = (date.getMonth()+1) + "";
            let day = date.getDate() + "";

            if(month.length==1) {
                month = "0" + month;
            }
            if(day.length==1) {
                day = "0" + day;
            }
            return year + "-" + month + "-" + day;
        }

        function fnExpectThead() {
            let hTag = '                    <tr>\n' +
                '                        <th><p class="sort expect" sort="membershipNumber">회원번호</p></th>\n' +
                '                        <th><p class="sort expect" sort="name">이름</p></th>\n' +
                '                        <th><p class="sort expect" sort="userId">아이디</p></th>\n' +
                '                        <th><p class="sort expect" sort="userLevel">레벨</p></th>\n' +
                '                        <th><p class="sort expect" sort="userTotal">총금액</p></th>\n' +
                '                        <th><p class="sort expect" sort="amount">예상수익금액</p></th>\n' +
                '                    </tr>';
            $("#expectProfitListThead").html(hTag);
        }

        function fnLastThead() {
            let hTag = '<tr>\n' +
                '                        <th><p class="sort last" sort="membershipNumber">회원번호</p></th>\n' +
                '                        <th><p class="sort last" sort="name">이름</p></th>\n' +
                '                        <th><p class="sort last" sort="userId">아이디</p></th>\n' +
                '                        <th><p class="sort last" sort="userLevel">레벨</p></th>\n' +
                '                        <th><p class="sort last" sort="total">총금액</p></th>\n' +
                '                        <th><p class="sort last" sort="amount">수익금액</p></th>\n' +
                '                    </tr>';
            $("#expectProfitListThead").html(hTag);
        }

        /** 모달 내 기능 시작 **/
        $("#expectProfitListTbody").on("click", ".open", function() {
            let name = $(this).find(".name").text();
            let modalToday = new Date();
            let modalPreDay = new Date(new Date().setMonth(new Date().getMonth()-6));
            $("#modalDateFrom").val(strDate(modalPreDay));
            $("#modalDateTo").val(strDate(modalToday));
            userDetailsSeq = $(this).attr("uSeq");
            getUserProfitDetails(userDetailsSeq);
            $("#title-name").text(name);
            $("#user-profit-detail-modal").css("display", "block");
        });

        $("#user-profit-detail-modal").on("click", ".searchBox", function(){
            getUserProfitDetails(userDetailsSeq);
        });

        $("#user-profit-detail-modal").on("click", ".month", function(){
            $("#user-profit-detail-modal .month").removeClass("yellow-btn")
            $("#user-profit-detail-modal .month").addClass("gray-btn")
            $(this).removeClass("gray-btn");
            $(this).addClass("yellow-btn");

            let minus = Number($(this).attr("val"));
            let modalDateTo = $("#modalDateTo").val();
            let preDate = new Date(modalDateTo);
            preDate = new Date(preDate.setMonth(preDate.getMonth()-minus));
            $("#modalDateFrom").val(strDate(preDate));
            getUserProfitDetails(userDetailsSeq);
        });

        function getUserProfitDetails(userDetailsSeq) {
            let dateFrom = $("#modalDateFrom").val();
            let dateTo = $("#modalDateTo").val();
            $.ajax({
                type:"get",
                url:"/api/admin/profits/users/"+userDetailsSeq,
                data:{
                    "dataFrom":dateFrom + " 00:00:00",
                    "dateTo":dateTo + " 23:59:59",
                    "userDetailsSeq":userDetailsSeq
                },
                success:function(data) {
                    let list = data.content;

                    let tag = '';
                    if(list!=null && list.length!=0) {
                        for (i = 0; i < list.length; i++) {
                            tag += '<tr>' +
                                '<td>' + list[i].createAt + '</td>' +
                                '<td>' + list[i].amount + '</td>' +
                                '<td>' + list[i].total + '</td>' +
                                '</tr>';
                        }

                    }
                    $("#modalUserProfitListTbody").html(tag);
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        };
        /** 모달 내 기능 끝**/
    </script>
    

</body>

</html>
