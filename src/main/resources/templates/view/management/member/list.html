<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout_admin}"
      xmlns:th="http://www.thymeleaf.org">

<style layout:fragment="css">
</style>

<!-- default_layout_admin.html 에 정의한 main page 부분 -->
<div layout:fragment="content">
    <!--컨텐츠 내용-->
    <div class="admin">
        <div class="pageTitle-wrap">
            <h3 class="title">회원 리스트</h3>
            <ul class="contentMenu">
                <li><a href="/management">HOME</a></li>
                <li><a href="/management/members">회원관리</a></li>
                <li><a href="/management/managers">회원 등급관리</a></li>
            </ul>
        </div>

        <div class="inventList page-tableBox pc768-wrap userList1">
            <div class="wait-list-2">
                <p>회원 등급 관리</p>
                <div class="search-wrap-admin search-wrap-userList">
                    <button class="comm-btn">접기</button>
                    <button id="btnUpdateGrade" class="comm-btn yellow-btn ">저장</button>
                </div>
            </div>

            <table class="page-table1 table-hover2 userList-table">
                <colgroup>
                    <col style="width:10%">
                    <col style="width:10%">
                    <col style="width:10%">
                    <col style="width:10%">
                    <col style="width:%">
                </colgroup>

                <thead>
                <tr>
                    <th>번호</th>
                    <th>등급명</th>
                    <th>회원수</th>
                    <th>비율</th>
                    <th>등급정보</th>
                </tr>
                </thead>
                <tbody id="gradeListTbody">
                <!--<tr onclick="" class="userList-detail">
                    <td><p>1</p></td>
                    <td><input type="text" class="userList-class w100" placeholder="준회원"></td>
                    <td><p class="userList-p">891</p></td>
                    <td><input type="text" class="userList-rate" placeholder="200"></td>
                    <td><input type="text" class="userList-info" placeholder="등급 정보를 입력해주세요."></td>
                </tr>
                <tr onclick="" class="userList-detail">
                    <td><p>1</p></td>
                    <td><input type="text" class="userList-class w100" placeholder="준회원"></td>
                    <td><p class="userList-p">891</p></td>
                    <td><input type="text" class="userList-rate" placeholder="200"></td>
                    <td><input type="text" class="userList-info" placeholder="등급 정보를 입력해주세요."></td>
                </tr>-->
                </tbody>
            </table>
        </div>

        <div class="inventList page-tableBox pc768-wrap wait-list userList2">
            <div class="wait-list-2">
                <p>회원 리스트<span id="memberCount"></span></p>
                <div>
                    <select class="mr10" id="withdrawal">
                        <option value="전체" selected>전체</option>
                        <option value="가입">가입</option>
                        <option value="탈퇴">탈퇴</option>
                    </select>
                    <select class="mr10" id="size">
                        <option value=20 selected>20</option>
                        <option value=40>40</option>
                        <option value=60>60</option>
                    </select>
                    <select class="mr10" id="queryType">
                        <option value="전체" selected>전체</option>
                        <option value="아이디">아이디</option>
                        <option value="이름">이름</option>
                    </select>
                    <div class="searchBox">
                        <input type="text" placeholder="검색어" id="query">
                        <span id="search-icon" class="search-icon"></span>
                    </div>
                </div>
            </div>

            <table class="page-table1 table-hover userList-table2">
                <colgroup>
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:15%">
                    <col style="width:*%">
                    <col style="width:*%">
                    <col style="width:*%">
                </colgroup>

                <thead id="memberListThead">
                <tr>
                    <th><p class="sort" sort="membershipNumber">회원번호</p></th>
                    <th><p class="sort" sort="userId">아이디</p></th>
                    <th><p class="sort" sort="name">이름</p></th>
                    <th><p class="sort" sort="birth">생년월일</p></th>
                    <th><p class="sort" sort="mobile">연락처</p></th>
                    <th><p class="sort" sort="email">이메일</p></th>
                    <th><p class="sort" sort="address">주소</p></th>
                    <th><p class="sort" sort="investment">레벨</p></th>
                    <th><p class="sort" sort="createdAt">가입일</p></th>
                    <th><p class="sort" sort="grade">회원등급</p></th>
                </tr>
                </thead>
                <tbody id="memberListTbody">
                <!--<tr onclick="" class="userList-detail2">
                    <td><p>0001</p></td>
                    <td><p>test00@gmail.com</p></td>
                    <td><p>김지영</p></td>
                    <td><p>1993-03-25</p></td>
                    <td><p>010-0000-0000</p></td>
                    <td><p>test00@gmail.com</p></td>
                    <td><p>경기도 부천시 소사구</p></td>
                    <td><p>5level</p></td>
                    <td><p>2022-09-15</p></td>
                    <td>
                        <select class="mr10">
                            <option value="대기">정회원</option>
                            <option value="승인">승인</option>
                        </select>
                    </td>
                </tr>
                <tr onclick="">
                    <td><p>0001</p></td>
                    <td><p>test00@gmail.com</p></td>
                    <td><p>김지영</p></td>
                    <td><p>1993-03-25</p></td>
                    <td><p>010-0000-0000</p></td>
                    <td><p>test00@gmail.com</p></td>
                    <td><p>경기도 부천시 소사구</p></td>
                    <td><p>5level</p></td>
                    <td><p>2022-09-15</p></td>
                    <td>
                        <select name="" id="" class="mr10">
                            <option value="대기">정회원</option>
                            <option value="승인">승인</option>
                        </select>
                    </td>
                </tr>-->
                </tbody>
            </table>
        </div>

        <!-- 모달창 -->
        <!-- <div class="invent-modal modal userList-modal">
             <div class="modal-inner">
                 <div class="modal-title">
                     <p class="title">관리자 추가</p>
                     <a href="#" class="close-btn">닫기</a>
                 </div>

                 <div class="modal-text">
                     <div class="text">
                         <p class="title">회원상태</p>
                         <select name="" id="">
                             <option>준회원</option>
                             <option>정회원</option>
                         </select>
                     </div>
                     <div class="text userList-modal-text">
                         <p class="title">레벨</p>
                         <p class="yellow">Level5</p>
                     </div>
                     <div class="text">
                         <p class="title">아이디</p>
                         <p>test01@gmail.com</p>
                     </div>
                     <div class="text">
                         <p class="title">생년월일</p>
                         <p>1993-03-25</p>
                     </div>
                     <div class="text">
                         <p class="title">연락처</p>
                         <p>010-1234-1111</p>
                     </div>
                     <div class="text">
                         <p class="title">이메일</p>
                         <p>test01@gmail.com</p>
                     </div>
                     <div class="text">
                         <p class="title">주소</p>
                         <p>인천 부평구 충선로 209번길 41</p>
                     </div>
                     <div class="text">
                         <p class="title">계좌정보</p>
                         <p>국민 0000000-000-000000</p>
                     </div>
                     <div class="text">
                         <p class="title">가입일</p>
                         <p>20222-02-02</p>
                     </div>
                     <div class="text">
                         <p class="title">추천인</p>
                         <p>test01@gmail.com</p>
                     </div>
                 </div>
                 <div class="modal-btn">
                     <a href="#" class="white-btn close-btn mr10">닫기</a>
                     <a href="#" class="yellow-btn">등록</a>
                 </div>
             </div>
             <div class="modal-bg"></div>
         </div>-->

        <div class="invent-modal modal userList-detail-modal">
            <div class="modal-inner">
                <div class="modal-title">
                    <p class="title"><span id="modalTitle" class="yellow"></span>님 상세정보</p>
                    <a href="#" class="close-btn">닫기</a>
                </div>

                <div class="modal-text">
                    <div class="text">
                        <p class="title">회원상태</p>
                        <select id="selMemberGrade">
                            <!--<option value="a">준회원</option>
                            <option value="b">탈퇴</option>-->
                        </select>
                    </div>
                    <div id="withdrawal-div" class="text d-none">
                        <p class="title">탈퇴사유</p>
                        <input type="text" id="withdrawalReason">
                    </div>
                    <div class="text userList-modal-text">
                        <p class="title">레벨</p>
                        <p class="yellow" id="memberLevel">Level5</p>
                    </div>
                    <div class="text">
                        <p class="title">아이디</p>
                        <p id="memberId">test01@gmail.com</p>
                    </div>
                    <div class="text">
                        <p class="title">생년월일</p>
                        <p id="memberBirth">1993-03-25</p>
                    </div>
                    <div class="text">
                        <p class="title">연락처</p>
                        <p id="memberMobile">010-1234-1111</p>
                    </div>
                    <div class="text">
                        <p class="title">이메일</p>
                        <p id="memberEmail">test01@gmail.com</p>
                    </div>
                    <div class="text">
                        <p class="title">주소</p>
                        <p id="memberAddress">인천 부평구 충선로 209번길 41</p>
                    </div>
                    <div class="text">
                        <p class="title">계좌정보</p>
                        <p id="memberAccount">국민 0000000-000-000000</p>
                    </div>
                    <div class="text">
                        <p class="title">가입일</p>
                        <p id="memberJoinDate">20222-02-02</p>
                    </div>
                    <div class="text">
                        <p class="title">추천인</p>
                        <p id="memberRecommender">test01@gmail.com</p>
                    </div>
                </div>
                <div class="modal-btn">
                    <a href="#" class="white-btn close-btn mr10">닫기</a>
                    <a href="#" id="btnUpdateMember" class="yellow-btn userList-register">수정</a>
                </div>
            </div>
            <div class="modal-bg"></div>
        </div>

        <!--paging-->
        <div id="pagination" class="paging">
            <!--            <a href="#" class="page-arrow1 page-arrow pc-mr05">처음 게시물 목록</a>-->
            <a href="#" class="page-arrow2 page-arrow">이전 게시물 목록</a>
            <div class="page-num">
                <a href="#" class="actived">1</a>
                <a href="#">2</a>
                <a href="#">3</a>
                <a href="#">4</a>
                <a href="#">5</a>
                <a href="#">6</a>
                <a href="#">7</a>
                <a href="#">8</a>
                <a href="#">9</a>
                <a href="#">10</a>
            </div>
            <a href="#" class="page-arrow3 page-arrow pc-mr05">다음 게시물 목록</a>
            <!--<a href="#" class="page-arrow4 page-arrow">마지막 게시물 목록</a>-->
        </div>
    </div>

    <script src="/js/script.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/dev.js"></script>

    <script>
        let page = 1;
        let size = $("#size").val();
        let query = "";
        let queryType = $("#queryType").val();
        let withdrawal = $("#withdrawal").val();
        let sort = "createdAt,desc";
        let modalUserDetailsSeq;
        let modalMemberGrade;
        let e;
        getGradeList();
        getMemberList();

        /*        $("#exit").on("change", function(){
                    let sel = $(this).val();
                    if(sel == "b") {
                        $("#withdrawal-div").removeClass("d-none");
                    }else {
                        $("#withdrawal-div").addClass("d-none");
                    }
                })*/


        $("#btnUpdateGrade").on("click", function () {
            e = 0;
            $(".gSeq").each(function () {
                let gTr = $(this).parent().parent();
                let gSeq = $(this).attr("seq");
                let gTitle = gTr.find(".gTitle").val();
                let gPercent = Number(gTr.find(".gPercent").val());
                let gComment = gTr.find(".gComment").val();

                let objGrade = {
                    "seq": gSeq,
                    "title": gTitle,
                    "percent": gPercent,
                    "comment": gComment
                }
                // console.log(objGrade);
                updateGrade(objGrade);
                if (e == 2) {
                    return false;
                }
            });
            if (e == 1) {
                toastModal("회원 등급 정보가 수정되었습니다.");
                setTimeout(() => location.reload(), 1000);
            }
        });

        function getGradeList() {
            $.ajax({
                type: "get",
                url: "/api/admin/members/grade",
                async: false,
                data: {},
                success: function (data) {
                    let gTag = '';
                    if (data != null && data.length != 0) {
                        for (i = 0; i < data.length; i++) {
                            gTag += '<tr>';
                            gTag += '<td><p class="gSeq" seq="' + data[i].seq + '">' + data[i].rowNum + '</p></td>';
                            gTag += '<td><input type="text" class="userList-class w100 gTitle" value="' + data[i].title + '"></td>';
                            gTag += '<td><p class="userList-p gCount">' + data[i].count + '</p></td>';
                            gTag += '<td><input type="text" class="userList-rate gPercent" value="' + data[i].percent + '"></td>';
                            gTag += '<td><input type="text" class="userList-info gComment" placeholder="등급 정보를 입력해주세요." value="' + data[i].comment + '"></td>';
                            gTag += '</tr>';
                        }
                    }
                    $("#gradeListTbody").html(gTag);
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        function getMemberList() {
            query = $("#query").val();
            queryType = $("#queryType").val();
            withdrawal = $("#withdrawal").val();
            size = $("#size").val();

            let objMember = {
                "query": query,
                "queryType": queryType,
                "withdrawal": withdrawal,
                "size": size,
                "page": page - 1,
                "sort": sort
            }

            $.ajax({
                type: "get",
                url: "/api/admin/members/users",
                data: objMember,
                async: false,
                success: function (data) {
                    // console.log(data);
                    let list = data.userList.content;
                    let mTag = '';
                    let arrGradeSeq = [];
                    if (list != null && list.length != 0) {
                        for (i = 0; i < list.length; i++) {
                            let address = '-';
                            if (list[i].address != null && list[i].address != '') {
                                address = list[i].address.split(';')[1];
                            }
                            let grade = '';
                            if (list[i].withdrawal == true) {
                                grade = '탈퇴';
                            } else {
                                grade = list[i].grade.title;
                            }

                            let email = list[i].email;
                            if(email==null || email=='') {
                                email = '-';
                            }
                            let birth = list[i].birth;
                            if(birth==null || birth=='') {
                                birth = '-';
                            }
                            let mobile = list[i].mobile;
                            if(mobile==null || mobile=='') {
                                mobile = '-';
                            }
                            mTag += '<tr class="userList-detail2" uSeq="' + list[i].userDetailsSeq + '">' +
                                '<td><p>' + list[i].membershipNumber + '</p></td>' +
                                '<td><p>' + list[i].userId + '</p></td>' +
                                '<td><p>' + list[i].name + '</p></td>' +
                                '<td><p>' + birth + '</p></td>' +
                                '<td><p>' + mobile + '</p></td>' +
                                '<td><p>' + email + '</p></td>' +
                                '<td><p>' + address + '</p></td>' +
                                '<td><p>' + list[i].level + '</p></td>' +
                                '<td><p>' + list[i].createdAt + '</p></td>' +
                                '<td><p>' + grade + '</p></td>' +
                                '</tr>';
                        }
                        fPagination(data.userList, page);
                    }
                    $("#memberListTbody").html(mTag);
                    $("#memberCount").html("총 회원수 "+data.userCount+"명");
                    //모달
                    $('.userList-detail2').click(function () {
                        $('.userList-detail-modal').css('display', 'block');
                        modalUserDetailsSeq = $(this).attr("uSeq");
                        getMemberDetails(modalUserDetailsSeq);
                        getSelGrade(modalMemberGrade);
                    });
                }
            });
        }

        // 모달 내 회원 등급 select 불러오기
        function getSelGrade(modalMemberGrade) {
            $.ajax({
                type: "get",
                url: "/api/admin/members/grade",
                async: false,
                data: {},
                success: function (data) {
                    let gTag = '';
                    if (data != null && data.length != 0) {
                        for (i = 0; i < data.length; i++) {
                            gTag += '<option value="' + data[i].seq + '">' + data[i].title + '</option>';
                        }
                        gTag += "<option value='withdrawal'>탈퇴</option>";
                    }
                    $("#selMemberGrade").html(gTag);

                    $("#selMemberGrade").val(modalMemberGrade).prop("selected", true);

                    $("#selMemberGrade").on("change", function () {
                        if ($(this).val() == "withdrawal") {
                            $("#withdrawal-div").removeClass("d-none");
                        } else {
                            $("#withdrawalReason").val("");
                            $("#withdrawal-div").addClass("d-none");
                        }
                    });
                },
                error: function (request, status, error) {
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        // 모달 회원 수정
        $("#btnUpdateMember").on("click", function(){
            modalMemberGrade = $("#selMemberGrade").val();

            if(modalMemberGrade=="withdrawal") {
                let withdrawalReason = $("#withdrawalReason").val();
                if(withdrawalReason=="") {
                    toastModal("탈퇴사유를 입력하세요");
                    return;
                }
                withdrawalMember(withdrawalReason);
            }else {
                updateMemberGrade()
            }
        });

        // 회원 등급 변경
        function updateMemberGrade() {
            $.ajax({
                type: "put",
                url: "/api/admin/members/users/" + modalUserDetailsSeq + "/grade",
                contentType: "application/json",
                data: JSON.stringify({
                    "gradeSeq": modalMemberGrade
                }),
                success: function (data) {
                    toastModal("등급이 변경되었습니다.");
                    setTimeout(() => location.reload(), 1000);
                },
                error: function (request, status, error) {
                    toastModal("회원등급 변경에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        // 회원 탈퇴 처리
        function withdrawalMember(withdrawalReason) {
            $.ajax({
                type: "delete",
                url: "/api/admin/members/users/" + modalUserDetailsSeq,
                contentType: "application/json",
                data: JSON.stringify({
                    "withdrawalReason": withdrawalReason
                }),
                success: function (data) {
                    toastModal("회원이 탈퇴되었습니다.");
                    setTimeout(() => location.reload(), 1000);
                },
                error: function (request, status, error) {
                    toastModal("회원탈퇴 처리에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }

        function updateGrade(objGrade) {
            $.ajax({
                type: "put",
                url: "/api/admin/members/grade/" + objGrade.seq,
                contentType: "application/json",
                data: JSON.stringify(objGrade),
                async:false,
                success: function (data) {
                    e = 1;
                },
                error: function (request, status, error) {
                    toastModal("회원 등급 정보 수정에 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                    e = 2;
                }
            });
        }

        // 사용자 상세 정보
        function getMemberDetails(userDetailsSeq) {
            $.ajax({
                type: "get",
                url: "/api/admin/members/users/" + userDetailsSeq,
                data: {},
                async: false,
                success: function (data) {
                    console.log(data);
                    if (data.withdrawal == false) {
                        modalMemberGrade = data.grade.gradeSeq;
                    } else {
                        modalMemberGrade = "withdrawal";
                    }

                    if (data.withdrawal == true) {
                        $("#withdrawal-div").removeClass("d-none");
                    } else {
                        $("#withdrawal-div").addClass("d-none");
                    }
                    $("#modalTitle").html(data.name);
                    $("#withdrawalReason").val(data.withdrawalReason);
                    $("#memberLevel").html(data.level);
                    $("#memberid").html(data.userid);
                    $("#memberBirth").html(data.birth);
                    $("#memberMobile").html(data.mobile);
                    $("#memberEmail").html(data.email);
                    let address = "-";
                    if (data.address != null && data.address != "") {
                        address = data.address.split(";")[1];
                    }
                    $("#memberAddress").html(address);
                    let account = "-";
                    if (data.bankName != null && data.bankName != "") {
                        account = data.bankName + " " + data.accountNumber;
                    }
                    $("#memberAccount").html(account);
                    $("#memberJoinDate").html(data.createdAt);
                    let recommender = "-";
                    if (data.recommender != null && data.recommender != "") {
                        recommender = data.recommender;
                    }
                    $("#memberRecommender").html(recommender);
                },
                error: function (request, status, error) {
                    toastModal("회원 정보를 불러오는데 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }


        // 페이징 클릭 시 실행
        $("#pagination").on("click", "a", function () {
            page = parseInt($(this).attr("gopage"));
            getMemberList();
        });

        // 가입/탈퇴 여부 select 변경 시
        $("#withdrawal").on("change", function () {
            withdrawal = $(this).val();
            page = 1;
            getMemberList();
        });

        // 출력 개수 select 변경 시
        $("#size").on("change", function () {
            size = $(this).val();
            page = 1
            getMemberList();
        });

        // 검색종류 select 변경 시
        $("#queryType").on("change", function () {
            queryType = $(this).val();
            page = 1
            getMemberList();
        });

        // 키워드 입력 후 Enter 눌렀을 경우
        $("#query").on("keydown", function (e) {
            if (e.keyCode == 13) {
                $("#search-icon").click();
            }
        });

        // 돋보기 아이콘 클릭 시 검색
        $("#search-icon").on("click", function () {
            page = 1
            getMemberList();
        });

        // 정렬
        $("#memberListThead").on("click", ".sort", function(){
            sort=$(this).attr('sort');

            if(!$(this).is('.actived')) {
                $(this).removeClass('actived');
                sort=sort+',desc'
            }else{
                $(this).addClass('actived');
                sort=sort;
            }

            $('.sort').not(this).removeClass('actived');
            page=1;
            getMemberList();
        });
    </script>
</div>

</html>
